if (-Not (Get-Service | Where-Object { $_.Name -eq 'CSFalconService' })) {
    $PROXY = ""
<% if p("falcon.installer_proxy_system_bypass", nil) -%>
  <% if p("falcon.aph", nil) -%>
    $ROXY += "<%= p('falcon.aph') %>"
  <% end -%>
  <% if p("falcon.app", nil) -%>
    $PROXY += ":<%= p('falcon.app') %>"
  <% end -%>
<% end -%>

    $INSTALLER_ARGS = "--config=C:\var\vcap\jobs\falcon-windows-sensor\config\config.yaml --user-agent=falcon-boshrelease/<%= p('version') %> --verbose --enable-file-logging --tmpdir C:\var\vcap\sys\log\falcon-windows-sensor"
    if ($PROXY -ne "") {
        $oldProxy = $env:https_proxy
        $env:https_proxy = $PROXY
        $process = (Start-Process -FilePath "C:\var\vcap\packages\falcon-windows-sensor\falcon-installer.exe" -ArgumentList $INSTALLER_ARGS -PassThru -NoNewWindow)
        Wait-Process -Id $process.Id
        $env:https_proxy = $oldProxy
    } else {
        $process = (Start-Process -FilePath "C:\var\vcap\packages\falcon-windows-sensor\falcon-installer.exe" -ArgumentList $INSTALLER_ARGS -PassThru -NoNewWindow)
        Wait-Process -Id $process.Id
    }
}
